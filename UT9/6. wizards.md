# 6. Wizards

> Basado en la sección **Wizard** del libro de desarrollo de Odoo 16 de Cybrosys. https://www.cybrosys.com/odoo/odoo-books/odoo-16-development/server-side-development/wizard/
---

## 1) ¿Qué es un Wizard en Odoo?

Un **Wizard** en Odoo es una interfaz temporal (normalmente un popup/modal) que guía al usuario para realizar una acción concreta en varios pasos o en un formulario corto.

En Odoo, lo habitual es implementarlo con:

- `models.TransientModel` → modelo temporal.
- Vista formulario en modo modal (`target="new"`).
- Botones de acción (`type="object"`) para ejecutar lógica Python.

Los datos del wizard son **temporales** y Odoo los limpia periódicamente.

---

## 2) Caso práctico: registrar ausencias de estudiantes

Vamos a crear un flujo donde:

1. Tienes un modelo `student.student`.
2. Desde la ficha del estudiante pulsas botón **Leave**.
3. Se abre un wizard para introducir:
   - fecha de ausencia
   - motivo
4. Al confirmar, se crea un registro en `student.leave`.

---

## 3) Estructura del módulo

~~~text
student_leave_wizard_demo/
├── __init__.py
├── __manifest__.py
├── security/
│   └── ir.model.access.csv
├── models/
│   ├── __init__.py
│   ├── student.py
│   └── student_leave.py
├── wizard/
│   ├── __init__.py
│   └── student_leave_wizard.py
└── views/
    ├── student_views.xml
    └── student_leave_wizard_views.xml
~~~

---

## 4) `__manifest__.py`

~~~python
{
    "name": "Student Leave Wizard Demo",
    "version": "16.0.1.0.0",
    "category": "Education",
    "summary": "Wizard para registrar ausencias de estudiantes",
    "depends": ["base"],
    "data": [
        "security/ir.model.access.csv",
        "views/student_views.xml",
        "views/student_leave_wizard_views.xml",
    ],
    "installable": True,
    "application": True,
}
~~~

---

## 5) Inicializadores

### `__init__.py`
~~~python
from . import models
from . import wizard
~~~

### `models/__init__.py`
~~~python
from . import student
from . import student_leave
~~~

### `wizard/__init__.py`
~~~python
from . import student_leave_wizard
~~~

---

## 6) Modelos persistentes

## 6.1 `models/student.py`

~~~python
from odoo import _, fields, models


class Student(models.Model):
    _name = "student.student"
    _description = "Student"

    name = fields.Char(string="Name", required=True)
    partner_id = fields.Many2one("res.partner", string="Partner")
    phone = fields.Char(string="Phone Number")
    email = fields.Char(string="Email", required=True)
    status = fields.Char(string="Status")
    leave_ids = fields.One2many("student.leave", "student_id", string="Leaves")

    def create_leave(self):
        """Abre el wizard en modal y precarga el estudiante actual."""
        self.ensure_one()

        wizard = self.env["student.leave.wizard"].create({
            "student_id": self.id,
        })

        return {
            "name": _("Student Leave"),
            "type": "ir.actions.act_window",
            "res_model": "student.leave.wizard",
            "view_mode": "form",
            "res_id": wizard.id,
            "target": "new",
        }
~~~

## 6.2 `models/student_leave.py`

~~~python
from odoo import fields, models


class StudentLeave(models.Model):
    _name = "student.leave"
    _description = "Student Leave"
    _order = "date desc, id desc"

    student_id = fields.Many2one("student.student", string="Student", required=True, ondelete="cascade")
    date = fields.Date(string="Date", required=True)
    reason = fields.Char(string="Reason", required=True)
~~~

---

## 7) Wizard temporal (`TransientModel`)

## `wizard/student_leave_wizard.py`

~~~python
from odoo import fields, models


class StudentLeaveWizard(models.TransientModel):
    _name = "student.leave.wizard"
    _description = "Student Leave Wizard"

    student_id = fields.Many2one("student.student", string="Student", readonly=True)
    date = fields.Date(string="Date", required=True)
    reason = fields.Char(string="Reason", required=True)

    def create_leave_from_wizard(self):
        """Crea una ausencia persistente usando los datos del wizard."""
        self.ensure_one()

        self.env["student.leave"].create({
            "student_id": self.student_id.id,
            "date": self.date,
            "reason": self.reason,
        })

        # Cierra el modal
        return {"type": "ir.actions.act_window_close"}
~~~

---

## 8) Vistas XML

## 8.1 `views/student_views.xml`

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Acción principal -->
    <record id="action_student_student" model="ir.actions.act_window">
        <field name="name">Students</field>
        <field name="res_model">student.student</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!-- Menús -->
    <menuitem id="menu_student_root" name="Student Management" sequence="10"/>
    <menuitem id="menu_student_student" name="Students" parent="menu_student_root" action="action_student_student" sequence="10"/>

    <!-- Vista árbol -->
    <record id="view_student_student_tree" model="ir.ui.view">
        <field name="name">student.student.tree</field>
        <field name="model">student.student</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="email"/>
                <field name="phone"/>
                <field name="status"/>
            </tree>
        </field>
    </record>

    <!-- Vista formulario -->
    <record id="view_student_student_form" model="ir.ui.view">
        <field name="name">student.student.form</field>
        <field name="model">student.student</field>
        <field name="arch" type="xml">
            <form string="Student">
                <header>
                    <button name="create_leave"
                            string="Leave"
                            type="object"
                            class="oe_highlight"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="partner_id"/>
                            <field name="phone"/>
                        </group>
                        <group>
                            <field name="email"/>
                            <field name="status"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Leaves">
                            <field name="leave_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="date"/>
                                    <field name="reason"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
</odoo>
~~~

## 8.2 `views/student_leave_wizard_views.xml`

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="leave_wizard_form_view" model="ir.ui.view">
        <field name="name">student.leave.wizard.form</field>
        <field name="model">student.leave.wizard</field>
        <field name="arch" type="xml">
            <form string="Leave">
                <sheet>
                    <group>
                        <group>
                            <field name="student_id"/>
                        </group>
                        <group>
                            <field name="date" required="1"/>
                        </group>
                    </group>
                    <separator string="Reason"/>
                    <field name="reason"
                           required="1"
                           nolabel="1"
                           placeholder="Give leave reason"/>
                </sheet>
                <footer>
                    <button type="object"
                            name="create_leave_from_wizard"
                            class="btn btn-primary"
                            string="CREATE"/>
                    <button string="CANCEL" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>
</odoo>
~~~

---

## 9) Seguridad (`ir.model.access.csv`)

> Nota: al ser demo, aquí damos acceso completo a usuarios internos. Ajusta grupos/permisos para producción.

## `security/ir.model.access.csv`

~~~csv
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_student_student_user,student.student user,model_student_student,base.group_user,1,1,1,1
access_student_leave_user,student.leave user,model_student_leave,base.group_user,1,1,1,1
access_student_leave_wizard_user,student.leave.wizard user,model_student_leave_wizard,base.group_user,1,1,1,1
~~~

---

## 10) Flujo funcional (resumen)

1. El usuario abre un `student.student`.
2. Pulsa botón **Leave**.
3. Método `create_leave()` crea registro temporal en `student.leave.wizard`.
4. Devuelve acción `ir.actions.act_window` en `target: "new"` (modal).
5. Usuario completa fecha/motivo y pulsa **CREATE**.
6. Método `create_leave_from_wizard()` crea registro real en `student.leave`.
7. Se cierra popup.
